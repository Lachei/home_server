<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@event-calendar/build/event-calendar.min.css">
<style>
    .selector_button {
        background-color: rgb(49, 114, 116);
        color: white;
        padding: 8px 8px;
        margin: 2px 10px;
        display: block;
        cursor: pointer;
    }
</style>
<div id="timetable"></div>
<div id="timetable_editing">
    <p><b>F&uuml;ge neues event hinzu</b></p>
    <div class="inset">
        <label for="ne_title"><b>Titel</b></label>
        <input id="ne_title" type="text">

        <label for="ne_description">Beschreibung</label><br />
        <textarea id="ne_description" name="ne_description" cols="40" rows="5"></textarea>

        <label for="ne_start_time"><b>Start Datum</b></label>
        <input id="ne_start_time" type="datetime-local">

        <label for="ne_end_time"><b>End Datum</b></label>
        <input id="ne_end_time" type="datetime-local">

        <label for="ne_people"><b>Mitarbeiter</b></label>
        <div id="associates" class="select_users"></div>

        <label for="ne_visibility"><b>Sichtbar f&uuml;r</b></label>
        <div id="visible" class="select_users select_all"></div>

        <label for="ne_expected_hours"><b>Voraussichtliche Arbeitsstunden</b></label>
        <input id="ne_expected_hours" type="number" value="5">

        <button onclick="
            let people = '[{{benutzername}}';
            for (p of document.getElementById('associates').querySelector('#side_select_right').childNodes) {
                if (p.innerHTML == 'Alle') {
                    people = '[all]';
                    break;
                }
                people += ',' + p.innerHTML;
            }
            if (people.slice(-1) != ']')
                people += ']';
            let visibility = '[{{benutzername}}';
            for (p of document.getElementById('visible').querySelector('#side_select_right').childNodes)
                visibility += ',' + p.innerHTML;
            visibility += ']';
            create_new_event({
            title : getElementById('ne_title').value,
            description: getElementById('ne_description').value,
            start_time: getElementById('ne_start_time').value,
            end_time: getElementById('ne_end_time').value,
            creator: '{{benutzername}}',
            people: people,
            people_status: '[{{benutzername}}, accepted]',
            visibility: visibility,
            expected_hours: parseFloat(getElementById('ne_expected_hours').value),
            progress: 0.,
        })">Event erstellen</button>
    </div>
</div>
<div style="display:none">
    <div id="side_select" style="display:grid; grid-template-columns: auto auto; grid-template-rows: auto auto; margin: 5px;">
        <div id="side_select_left_title" style="border:solid thin gray; border-bottom:none">
            Title links
            <hr>
        </div>
        <div id="side_select_right_title" style="border:solid thin gray; border-bottom:none">
            Title rechts
            <hr>
        </div>
        <div id="side_select_left" style="border:solid thin gray; border-top:none; max-height: 120px; overflow: scroll">
            left
        </div>
        <div id="side_select_right" style="border:solid thin gray; border-top:none; max-height: 120px; overflow: scroll;">
            right
        </div>
    </div>
</div>
<script onload="init_event_calendar(); setup_user_selections();"
    src="https://cdn.jsdelivr.net/npm/@event-calendar/build/event-calendar.min.js"></script>
<script>
    let event_calendar = null;
    console.log(new Date().toLocaleDateString('de-DE'));
    function db_event_to_cal_event(e) {
        return {
            id: e.id,
            resourceIds: [],
            allDay: e.expected_hours >= 24,
            start: new Date(e.start_time),
            end: new Date(e.end_time),
            title: e.title,
            editable: e.creator == "{{benutzername}}" || "admin" == "{{benutzername}}",
        }
    }
    async function init_event_calendar() {
        // loading events

        let server_events = await fetch(location.origin + "/get_events",
            { headers: { "credentials": location.search.substr(window.location.search.indexOf("=") + 1) } });
        let events = await server_events.json();

        // parsing the events to event calendar format
        let parsed_events = []
        for (e of events) {
            parsed_events.push(db_event_to_cal_event(e));
        }

        event_calendar = new EventCalendar(document.getElementById("timetable"), {
            view: 'timeGridWeek',
            headerToolbar: {
                start: 'prev,next today',
                center: 'title',
                end: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            events: parsed_events,
            allDayContent: "Ganztags",
            buttonText: { close: 'Schliessen', dayGridMonth: 'Monat', listDay: 'Liste', listMonth: 'Liste', listWeek: 'Liste', listYear: 'Liste', resourceTimeGridDay: 'Tag', resourceTimeGridWeek: 'Woche', timeGridDay: 'Tag', timeGridWeek: 'Woche', today: 'Heute' },
            //date: new Date().toISOString()
            dayHeaderFormat: date => new Intl.DateTimeFormat('de-DE', { weekday: 'short', month: 'numeric', day: 'numeric' }).format(date),
            editable: true
        });
    }
    async function create_new_event(event_infos) {
        console.log(event_infos);

        let event_result = await fetch(location.origin + "/add_event",
            {
                headers: { "credentials": location.search.substring(location.search.indexOf("=") + 1) },
                method: "POST",
                body: JSON.stringify(event_infos)
            });
        let event_result_json = await event_result.json();
        if ("error" in event_result_json)
            console.log(event_result_json);
        else
            event_calendar.addEvent(db_event_to_cal_event(event_result_json));
    }
    async function setup_user_selections() {
        let users = await fetch(location.origin + "/get_all_users", { headers: { "credentials": location.search.substring(location.search.indexOf("=") + 1) }, });
        users = await users.json();
        const create_selector = (id, contains_all) => {
            let select = document.getElementById("side_select");
            let selector = select.cloneNode(true);
            selector.setAttribute("id", id);
            selector.querySelector("#side_select_left_title").innerHTML = "<p class='p_title'>Nicht dabei <hr>";
            selector.querySelector("#side_select_right_title").innerHTML = "<p class='p_title'>Mit dabei <hr>";

            let user_buttons = "";
            for (user of users)
                if (user != "{{benutzername}}")
                    user_buttons += "<button class='selector_button' onclick=\"switch_side('" + user + "', this);\">" + user + "</button>\n";
            selector.querySelector("#side_select_left").innerHTML = user_buttons;
            let right_buttons = "";
            if (contains_all)
                right_buttons += "<button class='selector_button' onclick=\"switch_side('all', this);\">Alle</button>\n";
            selector.querySelector("#side_select_right").innerHTML = right_buttons;
            return selector;
        }
        let selectors = document.getElementsByClassName("select_users");
        for (s of selectors) {
            const contains_all = s.classList.contains("select_all");
            const id = s.getAttribute("id") + "_selector";
            const selector = create_selector(id, contains_all);
            s.appendChild(selector);
        }
    }
    function switch_side(user_name, button) {
        let p = button.parentNode;
        let other_side = p.getAttribute("id") == "side_select_left" ? "side_select_right" : "side_select_left";
        p.removeChild(button);
        p.parentNode.querySelector("#" + other_side).appendChild(button);
    }
</script>